<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{ font-family: system-ui, Arial; padding:20px; max-width:760px; }
    .note{ color:#555; font-size:0.95rem; }
    button{ padding:10px 14px; border-radius:8px; cursor:pointer; }
    pre{ background:#f6f6f6; padding:12px; border-radius:6px; overflow:auto; }
  </style>
</head>
<body>
  <h2>Share location </h2>
  <p class="note">
    Clicking the button will ask for permission to read your location. Only location coordinates, a timestamp, and a Google Maps link are sent to the form — no name or other personal fields.
  </p>

  <p>
    <button id="sendBtn">Share my location</button>
  </p>

  <div id="status" aria-live="polite"></div>
  <pre id="log"></pre>

<script>
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xdkpwwej'; 
const sendBtn = document.getElementById('sendBtn');
const status = document.getElementById('status');
const logEl = document.getElementById('log');

function log(...s){ logEl.textContent += s.join(' ') + '\n'; }
function setStatus(s){ status.textContent = s; }

async function sendToFormspree(payload) {
  setStatus('Sending location to Formspree...');
  log('Payload to send:', JSON.stringify(payload));
  try {
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      setStatus('Location sent successfully ✅');
      const text = await res.text();
      log('Formspree response:', res.status, text);
    } else {
      setStatus('Failed to send — form responded with status ' + res.status);
      const errText = await res.text();
      log('Formspree error:', res.status, errText);
    }
  } catch (err) {
    setStatus('Network error sending to Formspree.');
    log('Network error:', err);
  }
}

async function ipFallbackAndSend(reason) {
  setStatus('Permission denied or geolocation unavailable — using IP-based fallback (approximate).');
  log('Fallback reason:', reason);
  try {
    const resp = await fetch('https://ipapi.co/json/');
    if (!resp.ok) throw new Error('IP API failed: ' + resp.status);
    const j = await resp.json();
    const payload = {
      source: 'ip_fallback',
      coords: {
        latitude: j.latitude || null,
        longitude: j.longitude || null,
        accuracy_m: null,
        maps_url: j.latitude && j.longitude ? `https://www.google.com/maps?q=${j.latitude},${j.longitude}` : null
      },
      ip_city: j.city || null,
      ip_region: j.region || null,
      ip_country: j.country_name || null,
      timestamp: new Date().toISOString()
    };
    await sendToFormspree(payload);
  } catch (e) {
    setStatus('IP fallback failed — cannot determine location.');
    log('IP fallback error:', e);
  }
}

sendBtn.addEventListener('click', async () => {
  const want = confirm('This site will request your location and send only coordinates, timestamp, and a Google Maps link to a form for testing. Proceed?');
  if (!want) {
    setStatus('User cancelled consent.');
    return;
  }

  if (!('geolocation' in navigator)) {
    ipFallbackAndSend('no_geolocation_api');
    return;
  }

  setStatus('Requesting location permission…');
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = Number(pos.coords.latitude.toFixed(6));
    const lon = Number(pos.coords.longitude.toFixed(6));
    const accuracy = pos.coords.accuracy ? Math.round(pos.coords.accuracy) : null;
    const payload = {
      source: 'browser_geolocation',
      coords: {
        latitude: lat,
        longitude: lon,
        accuracy_m: accuracy,
        maps_url: `https://www.google.com/maps?q=${lat},${lon}`
      },
      timestamp: new Date(pos.timestamp).toISOString()
    };
    log('Got coords from browser:', JSON.stringify(payload.coords));
    await sendToFormspree(payload);
  }, (err) => {
    console.warn('Geolocation error', err);
    ipFallbackAndSend(err && err.message ? err.message : 'permission_denied_or_error');
  }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
});
</script>
</body>
</html>
